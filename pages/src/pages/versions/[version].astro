---
import { joinURL, withTrailingSlash } from "ufo";
import { Octokit } from "@octokit/rest";
import prettyBytes from "pretty-bytes";
import type { GetStaticPathsOptions, GetStaticPathsResult } from "astro";

import {
  GITHUB_OWNER,
  GITHUB_REPO,
  GITHUB_URL,
  PRODUCTION_BASE_URL,
} from "../../lib/info.js";
import DefineFileVerifierDropArea from "../../components/DefineFileVerifierDropArea.astro";
import DefineLocalDate from "../../components/DefineLocalDate.astro";
import Layout from "../../layouts/Layout.astro";
import type { FileVerifierReleaseAsset } from "../../components/FileVerifierResultDialog.js";

import GitHubMarkWhite from "../../../public/github-mark-white.svg";

interface Props {
  release: Awaited<
    ReturnType<Octokit["rest"]["repos"]["getReleaseByTag"]>
  >["data"];
  latestRelease: Awaited<
    ReturnType<Octokit["rest"]["repos"]["getLatestRelease"]>
  >["data"];
}

export async function getStaticPaths(
  options: GetStaticPathsOptions,
): Promise<GetStaticPathsResult> {
  const octokit = new Octokit({ auth: import.meta.env.GITHUB_TOKEN });

  const allReleases = await octokit.paginate(octokit.rest.repos.listReleases, {
    owner: GITHUB_OWNER,
    repo: GITHUB_REPO,
    per_page: 100,
  });

  const publishedReleases = allReleases.filter(
    (release) => !release.draft && release.published_at,
  );

  const latestRelease = await octokit.rest.repos.getLatestRelease({
    owner: GITHUB_OWNER,
    repo: GITHUB_REPO,
    headers: {
      accept: "application/vnd.github.v3.text+json",
    },
  });

  return publishedReleases.map((release) => ({
    params: { version: release.tag_name },
    props: { release, latestRelease: latestRelease.data },
  }));
}

const { BASE_URL } = import.meta.env;

function stripMarkdown(markdown: string): string {
  if (!markdown) return "";

  return markdown
    .replace(/^#+\s+/gm, "")
    .replace(/^[\s\-*+]+/gm, "")
    .replace(/\[([^\]]+)\]\([^)]+\)/g, "$1")
    .replace(/```/g, "")
    .replace(/[*_]{1,2}([^*_]+)[*_]{1,2}/g, "$1")
    .replace(/\s+/g, " ")
    .trim();
}

const { release, latestRelease } = Astro.props;

const windowsZipAsset = release.assets.find((a) =>
  a.name.endsWith("windows-x64.zip"),
);
const macosPkgAsset = release.assets.find((a) =>
  a.name.endsWith("macos-universal.pkg"),
);
const ubuntuDebAsset = release.assets.find((a) =>
  a.name.endsWith("x86_64-linux-gnu.deb"),
);

const releaseBody = release.body || "No release notes provided.";

const releaseAssets = release.assets.map(
  (asset) =>
    ({
      name: asset.name,
      size: asset.size,
      digest: asset.digest,
    }) satisfies FileVerifierReleaseAsset,
);

const baseDescription = `Download version ${release.tag_name} of OBS Background Removal.`;
const cleanBody = stripMarkdown(releaseBody);
const dynamicDescription = cleanBody
  ? (() => {
      const full = `${baseDescription} Highlights: ${cleanBody}`;
      const truncated = full.substring(0, 160);
      return truncated + (full.length > 160 ? "..." : "");
    })()
  : `${baseDescription} Check release notes for details.`;
---

<Layout
  lang="en"
  title={`OBS Background Removal ${release.tag_name} - Download & Release Notes`}
>
  <Fragment slot="head-info">
    <meta name="description" content={dynamicDescription} />
    <link
      rel="canonical"
      href={withTrailingSlash(
        joinURL(PRODUCTION_BASE_URL, "versions", release.tag_name),
      )}
    />
  </Fragment>

  <Fragment slot="head-bottom">
    <DefineFileVerifierDropArea />
    <DefineLocalDate />
  </Fragment>

  <main class="white-box">
    <article>
      <hgroup class="version-header">
        <div class="version-title-row">
          <h1>Version {release.tag_name}</h1>
          {
            release.id === latestRelease.id && (
              <span class="badge-latest">Latest</span>
            )
          }
        </div>
        <h2>OBS Background Removal</h2>
      </hgroup>

      {
        release.prerelease && (
          <aside class="alert-box" aria-label="Version stability warning">
            <p>
              <strong>Pre-release:</strong>
              This version is unstable. Not recommended for use.
            </p>
          </aside>
        )
      }

      <section class="downloads-section">
        <h2>Downloads</h2>

        <ul class="download-links">
          {
            windowsZipAsset && (
              <li>
                <a href={windowsZipAsset.browser_download_url}>Windows (zip)</a>
              </li>
            )
          }
          {
            macosPkgAsset && (
              <li>
                <a href={macosPkgAsset.browser_download_url}>Mac (pkg)</a>
              </li>
            )
          }
          {
            ubuntuDebAsset && (
              <li>
                <a href={ubuntuDebAsset.browser_download_url}>Ubuntu (deb)</a>
              </li>
            )
          }
          <li>
            <a
              href="https://github.com/kaito-tokyo/live-backgroundremoval-lite/tree/main/unsupported/flatpak"
              >Flatpak (Latest)</a
            >
          </li>
          <li>
            <a
              href="https://github.com/kaito-tokyo/live-backgroundremoval-lite/tree/main/unsupported/arch"
              >Arch Linux (Latest)</a
            >
          </li>
        </ul>
      </section>

      <div class="github-row">
        <a
          href={release.html_url}
          target="_blank"
          rel="noopener noreferrer"
          class="github-button"
        >
          <GitHubMarkWhite viewBox="0 0 98 96" width="24" height="24" />
          <span>View on GitHub</span>
        </a>
      </div>

      <file-verifier-drop-area id="verifier"></file-verifier-drop-area>

      <section class="release-notes">
        <h2>Release notes</h2>
        <pre>{releaseBody}</pre>
      </section>

      <section>
        <h2>Additional Information</h2>
        <dl>
          <dt>Publish date</dt>
          <dd>
            <local-date data-date={release.published_at}
              ><time datetime={release.published_at}
                >{release.published_at}</time
              ></local-date
            >
          </dd>
          {
            windowsZipAsset?.digest && (
              <Fragment>
                <dt>{windowsZipAsset.name}</dt>
                <dd>{prettyBytes(windowsZipAsset.size, { binary: true })}</dd>
                <dd>
                  <code>{windowsZipAsset.digest}</code>
                </dd>
              </Fragment>
            )
          }

          {
            macosPkgAsset?.digest && (
              <Fragment>
                <dt>{macosPkgAsset.name}</dt>
                <dd>{prettyBytes(macosPkgAsset.size, { binary: true })}</dd>
                <dd>
                  <code>{macosPkgAsset.digest}</code>
                </dd>
              </Fragment>
            )
          }

          {
            ubuntuDebAsset?.digest && (
              <Fragment>
                <dt>{ubuntuDebAsset.name}</dt>
                <dd>{prettyBytes(ubuntuDebAsset.size, { binary: true })}</dd>
                <dd>
                  <code>{ubuntuDebAsset.digest}</code>
                </dd>
              </Fragment>
            )
          }
        </dl>
      </section>

      <nav class="page-nav" aria-label="Page navigation">
        <ul>
          <li>
            <a href={withTrailingSlash(BASE_URL)}>Back to Top</a>
          </li>
          <li>
            <a href={withTrailingSlash(joinURL(BASE_URL, "versions"))}
              >Back to Version List</a
            >
          </li>
          <li>
            <a
              href={withTrailingSlash(GITHUB_URL)}
              target="_blank"
              rel="noopener noreferrer">GitHub Repository</a
            >
          </li>
        </ul>
      </nav>
    </article>

    <file-verifier-result-dialog
      id="verifier-dialog"
      data-release-assets={JSON.stringify(releaseAssets)}
    ></file-verifier-result-dialog>
  </main>

  <Fragment slot="body-bottom">
    <script>
      import { FileVerifierResultDialog } from "../../components/FileVerifierResultDialog"; // 前回のクラス定義をimport

      customElements.define(
        "file-verifier-result-dialog",
        FileVerifierResultDialog,
      );

      function uint8ArrayToHex(bytes: Uint8Array): string {
        return Array.from(bytes)
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");
      }

      const verifierDropArea = document.getElementById("verifier");

      const verifierResultDialog = document.getElementById(
        "verifier-dialog",
      ) as FileVerifierResultDialog;

      if (!verifierDropArea || !verifierResultDialog)
        throw new Error("File verifier elements not found.");

      verifierDropArea.addEventListener("file-verifier-file-dropped", (e) => {
        const { name, size, sha256Buffer } = e.detail;
        verifierResultDialog.addResult({
          name,
          size,
          sha256: uint8ArrayToHex(new Uint8Array(sha256Buffer)),
        });
        verifierResultDialog.showModal();
      });

      verifierDropArea.addEventListener("file-verifier-error", (e) => {
        const { name, size, error } = e.detail;
        verifierResultDialog.addResult({
          name,
          size,
          error,
        });
        verifierResultDialog.showModal();
      });
    </script>
  </Fragment>
</Layout>

<style is:global>
  main {
    .version-title-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .version-title-row h1 {
      margin: 0;
    }

    .badge-latest {
      display: inline-block;
      padding: 0.25rem 0.6rem;
      font-size: 0.85rem;
      font-weight: 600;
      line-height: 1;
      color: #ffffff;
      background-color: var(--color-download-button-bg);
      border-radius: 2em;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .alert-box {
      background-color: var(--color-alert-bg);
      color: var(--color-alert-fg);
      padding: 0.5rem 1rem;
      border-radius: 1rem;
    }

    .download-links {
      margin-bottom: 1rem;
    }

    dt {
      font-weight: 600;
    }

    dd code {
      word-break: break-all;
      white-space: pre-wrap;
    }

    .release-notes pre {
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      max-width: 100%;
      background-color: #f8f9fa;
      padding: 1.5rem;
    }

    .github-row {
      display: flex;
      justify-content: center;
      margin: 1rem 0;
    }

    .github-button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background-color: var(--color-github-black);
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      text-decoration: none;
      font-weight: 600;
      font-size: 18px;
    }
  }
</style>
