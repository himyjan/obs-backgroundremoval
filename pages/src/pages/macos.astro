---
import { joinURL, withTrailingSlash } from "ufo";
import { Octokit, type RestEndpointMethodTypes } from "@octokit/rest";

import Layout from "../layouts/Layout.astro";

import { GITHUB_OWNER, GITHUB_REPO, PRODUCTION_BASE_URL } from "../lib/info.js";

export type LatestRelease =
  RestEndpointMethodTypes["repos"]["getLatestRelease"]["response"]["data"];

const { BASE_URL } = import.meta.env;

async function getLatestRelease(): Promise<LatestRelease> {
  const octokit = new Octokit({ auth: import.meta.env.GITHUB_TOKEN });

  const latestRelease = await octokit.rest.repos.getLatestRelease({
    owner: GITHUB_OWNER,
    repo: GITHUB_REPO,
  });

  return latestRelease.data;
}

const release = await getLatestRelease();

const asset = release.assets.find((e) => /macos-universal\.pkg/.test(e.name));
if (!asset) throw new Error("macOS asset not found!");
---

<Layout lang="en" title="How to use OBS Background Removal on macOS">
  <Fragment slot="head-info">
    <meta
      name="description"
      content="How to use OBS Background Removal on macOS"
    />
    <link
      rel="canonical"
      href={withTrailingSlash(joinURL(PRODUCTION_BASE_URL, "macos"))}
    />
  </Fragment>

  <main class="white-box">
    <h1>Install OBS Background Removal on macOS</h1>

    <div
      style="background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 12px; margin-bottom: 20px;"
    >
      <strong>⚠️ Architecture Compatibility Warning:</strong><br />
      This plugin does <strong>NOT</strong> support cross-architecture translation
      (Rosetta2). If you run an Intel OBS binary on Apple Silicon via Rosetta2, or
      an Apple Silicon binary on Intel Macs, the plugin will crash. Always use OBS
      Studio and this plugin built for your Mac's native architecture.
    </div>

    <ol>
      <li>
        <strong>Download the Plugin Installer:</strong><br />
        <a href={asset.browser_download_url} download>
          Click here to download the latest macOS installer (PKG)
        </a>
      </li>
      <li>
        <strong>Run the Installer:</strong><br />
        Double-click <code>{asset.name}</code> and follow the instructions to install.
      </li>
      <li>
        <strong>Restart OBS Studio:</strong><br />
        If OBS Studio is running, close it and open it again.
      </li>
      <li>
        <strong>Usage:</strong><br />
        See the <a href={joinURL(BASE_URL, "usage/")}>usage page</a> for how to use
        the plugin.
      </li>
    </ol>

    <p>All set!</p>

    <p><a href={joinURL(BASE_URL, "/")}>Back to the top page</a></p>
  </main>
</Layout>
